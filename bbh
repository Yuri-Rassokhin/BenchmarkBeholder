#!/usr/bin/env ruby

require 'bundler/setup'
require 'flex-cartesian'
require 'open3'
require 'fileutils'
require 'tempfile'
require 'json'
require 'dry-validation'
require 'logger'
require 'telegram'
require 'net/http'
require 'json'
require 'optparse'

require './sources/infra/scheduler'
require './sources/infra/platform'
require './sources/infra/utilities_general' # TODO: restructure
require './sources/options'
#require './sources/target' # TODO: correct it and enable
require './sources/config'
require './sources/node'
require './sources/workload'
require './sources/log'
require './sources/utilities'

logger = Log.new

options = Options.new(logger, ARGV)
config = Config.new(logger, options.workload)
workload = Workload.new(logger: logger, config: config)

logger.info "parameter space: #{workload.dimensions(separator: ', ')}"
logger.info "total invocations: #{workload.size}"
exit 0 if options.space_mode

Node.check(logger: logger, config: config)

workload.preparation

platform = Platform.new(logger, config.target)

workload.benchmark

#TODO: to replace this chunk with last function that pushes each result outside
#TODO: to initialize the report in prepare method of the hook
#report = "./log/bbh-#{hook}-#{series}-result.csv"
#FileUtils.mkdir_p(File.dirname(report))
#space.output(format: :csv, file: report)
#space.output(colorize: true, align: true)

